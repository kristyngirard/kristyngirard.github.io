<html hola_ext_inject="ready">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Sentiment Analysis Classifier</title>

	<script type="text/javascript" src="negative.js"></script>

	<script type="text/javascript" src="positive.js"></script>

	<script type="text/javascript" src="PorterStemmer1980.min.js"></script>

	<script type="text/javascript" src="bayes.js"></script>


	<link rel="stylesheet" type="text/css" href="sentiment.css">



<script type="text/javascript">//<![CDATA[
window.onload=function(){

// Used to inspect data points guessed incorrectly
var incorrectNegs = [];
var incorrectPos = [];

// A list of negation terms used to flag nearby tokens
var negations = new RegExp("^(never|no|nothing|nowhere|noone|none|not|havent|hasnt|hadnt|cant|couldnt|shouldnt|wont|wouldnt|dont|doesnt|didnt|isnt|arent|aint)$");

// Cross-validation: 80% of data for training, 20% for testing
// negatives : dataset
// only the negatives are used since the negative and position datasets are the same length
var length = negatives.length;
var split = Math.floor(0.80 * length);

// Add Negation and Stemming techniques
Bayes.tokenizer = function (text) {
    // Standard unigram tokenizer; lowercase, strip special characters, split by whitespace
    text = Bayes.unigramTokenizer(text);

		/* NEGATION */

		// Step through array of tokens
    for (var i = 0; i < text.length; i++) {
        // If negation word found, add a * to the word before and after it
        if (text[i].match(negations)) {
            if (typeof text[i + 1] !== 'undefined') text[i + 1] = "*" + text[i + 1];
            if (typeof text[i - 1] !== 'undefined') text[i - 1] = "*" + text[i - 1];
        }
    }

		/* STEMMING*/

    // Use Porter Stemmer algorithm
    text = text.map(function (t) { return stemmer(t); });


    return text;
};

// Set the storage engine to in-memory
Bayes.storage = Storage;

// Runs single training and testing
function classify() {

    var numCorrect = 0;
    var numIncorrect = 0;
    var numSkipped = 0;
    var resultsPercent = 0.0;

    Bayes.storage._data = {};

    // Shuffle datasets
    negatives.sort(function () { return Math.random() - 0.5; });
    positives.sort(function () { return Math.random() - 0.5; });


		/* TRAINING */

    // Loop through data until split point. Then train on both datasets
    for (var i = 0; i < split; i++) {
        Bayes.train(negatives[i], 'negative');
        Bayes.train(positives[i], 'positive');
    }


		/* TESTING */

    // Look at remainder of data set (split to end) and test each one
    for (var i = split; i < length; i++) {
        var negResult = Bayes.getClassification(Bayes.guess(negatives[i]));
        var posResult = Bayes.getClassification(Bayes.guess(positives[i]));

				/* THRESHOLD */

        // If the probability is less than 80%, just ignored it
        if (negResult.score < 0.80) numSkipped++;
        else if (negResult.category === 'negative') numCorrect++;
        else {
						numIncorrect++;
            incorrectNegs.push(negatives[i]);
        }

        // Repeat for the corresponding positive dataset
        if (posResult.score < 0.80) numSkipped++;
        else if (posResult.category === 'positive') numCorrect++;
        else {
						numIncorrect++;
            incorrectPos.push(positives[i]);
        }
    }

    // Return the accuracy for this training/testing run.
    resultsPercent = Math.round(10000 * numCorrect / (numCorrect + numIncorrect)) / 100;

    return resultsPercent;
}

// Interface for user inputted text
document.getElementById("testButton").addEventListener('click', function() {
    var text = document.getElementById("testBox").value;
    var result = Bayes.getClassification(Bayes.guess(text));
    document.getElementById("testBox").value = '';
    document.getElementById("testResultCategory").innerHTML = result.category;
    document.getElementById("testResultProbability").innerHTML = Math.round(100*result.score);
    document.getElementById("testResult").style.display = 'block';
});

// Run classification procedure multiple times
function runTests() {
    var numTests = 20;
    var count = 0;
    var scores = [];
    var sum = 0;

		console.log("--- Sentiment Analysis Console --- ");
		console.log("");
		console.log("--- Testing " + numTests +" times --- ");

    while (count < numTests) {
			// Get accuracy for one classification
			var result = classify();

			scores.push(result);

			console.log("Test "+ (count+1) +": accuracy " + result +"%");

			count++;
		}

		// calculate total sum of all scores
    scores.forEach(function (score) {
        sum += score;
    });

		var average = sum / numTests;

		console.log("");
    console.log("Average Accuracy: " + average + "%");

		// Display the average accuracy
		var resultsBar = document.getElementById("testResultsBar");
		var resultsVal = document.getElementById("testResultsValue");
		resultsBar.style.width = Math.round(average) + '%';
		resultsVal.innerHTML = average;

		return average;
}

setTimeout(runTests, 500);

}//]]>
</script>





</head>

<h3>Movie Review Sentiment Analysis Classifier</h3>

<body hola-ext-player="1">

	    <p>Average Testing Accuracy: <span id="testResultsValue">0</span>%</p>
	    <div class="progress-wrapper">
	        <div class="progress" id="testResultsBar"></div>
	    </div>

	    <p>Test your own:</p>
	    <textarea id="testBox" placeholder="eg: The director is a master at manupulating your emotions, making you laugh and cry."></textarea>
	    <button id="testButton">Guess Sentiment</button>
	    <p id="testResult" style="display:none;">Guess: <span id="testResultCategory"></span> (<span id="testResultProbability"></span>% probability)</p>
</body>

</html>
